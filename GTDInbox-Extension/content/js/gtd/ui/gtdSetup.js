var gtdSetup=giPopupNotice.extend({connect:function(main){giLogger.log("st","gtdSetup.connect",main?main.pageId:giLogger.UNKNOWN_PAGE_ID);this.id="gtdsetup";this.base(main);this._eventsContainer=new giEventsContainer(this);this.addEventListener(giPopupNotice.CONTENT_LOADED,this._contentLoaded,this);this._load("gtdSetup.htm")},_contentLoaded:function(){try{var doc=this._main.gmail.canvasDocument;var elChecks=doc.getElementById("gtdi-gtdsetup-labels");var sd=this._main.labelsData.getStatusData(null,
true);var statuses=this._main.labelsData.getLabelsHash("statuses");var coreLabels=this._main.prefs.getPref("labels.types.statuses.core");for(d in coreLabels)if(coreLabels[d].autoInstall&&!statuses[sd[d]])this._createCheckbox(elChecks,sd[d]);this._main.gmail.environment.addEventListener(glEnvironment.CREATE_LABEL,this._createLabelEvent,this);this._loaded=true;if(this._onLoadQueue){for(var i=0;i<this._onLoadQueue.length;i++)this._onLoadQueue[i]();this._onLoadQueue=null}}catch(e){giLogger.warn(e,"gtdSetup._contentLoaded",
null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},disconnect:function(){this._main.gmail.environment.removeEventListener(glEnvironment.CREATE_LABEL,this._createLabelEvent,this);this.base()},_createCheckbox:function(elContainer,label){var doc=elContainer.ownerDocument;var elCheckContainer=doc.createElement("DIV");var elCheck=doc.createElement("INPUT");elCheck.setAttribute("type","checkbox");elCheck.setAttribute("gtdi-item",label);elCheck.setAttribute("gtdi-type",gtdBrowser.TYPES.LABEL);
elCheck.checked=true;elCheckContainer.appendChild(elCheck);elCheckContainer.appendChild(doc.createTextNode(label));elContainer.appendChild(elCheckContainer);return elCheckContainer},hideHide:function(){if(!this._loaded){if(!this._onLoadQueue)this._onLoadQueue=[];var me=this;this._onLoadQueue.push(function(){me.hideHide()});return}var el=this.el.ownerDocument.getElementById("gtdi-gtdsetup-hidemsg");el.parentNode.removeChild(el)},_click:function(evt){try{var el=evt.target;if(el.id=="gtdi-gtdsetup-install"){var els=
this.el.ownerDocument.getElementById("gtdi-gtdsetup-labels").getElementsByTagName("INPUT");this._labels={};var foundOne=false;for(var i=0;i<els.length;i++)if(els[i].checked){foundOne=true;this._labels[els[i].getAttribute("gtdi-item")]=false}if(!foundOne)return;el.innerHTML+="&nbsp;<img src='"+giUrl.getURL("skin/indicator_small.gif")+"' />";el.disabled=true;for(l in this._labels)this._main.gmail.actions.performAction(glActionManager.CREATE_LABEL,null,glActionManager.USE_AJAX,l);var me=this;setTimeout(function(){if(confirm(giI18N.getString("Box.setup.complete")))me._main.gmail.page.reloadGmail()},
1500)}if(el.id=="gtdi-gtdsetup-hide"){this._main.prefs.setPref("components.navigation.gtd_setup.disabled",true);this._main.getUIObject("boxSetup").disconnect();this.disconnect()}this.base(evt)}catch(e){giLogger.warn(e,"gtdSetup._click",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_createLabelEvent:function(evt){if(typeof this._labels[evt.label]!="undefined")this._labels[evt.label]=true;var fail=false;for(l in this._labels)if(!this._labels[l]){fail=true;break}if(!fail)this.disconnect()}});
