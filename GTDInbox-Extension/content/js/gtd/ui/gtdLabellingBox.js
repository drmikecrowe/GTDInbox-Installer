var gtdLabellingBox=giUIObject.extend({_id:null,_autoUpdate:null,_hideCmds:null,_uiRows:null,_labellingDropdowns:null,_eventsContainer:null,thread:null,el:null,elRows:null,_serverActionType:null,_elCmdButtons:null,_elNotify:null,_elExpander:null,_actionAndMove:null,connect:function(main){giLogger.log("st","gtdLabellingBox.connect",main?main.pageId:giLogger.UNKNOWN_PAGE_ID);this.base(main);this._eventsContainer=new giEventsContainer(this);this._uiRows={};this._labellingDropdowns={};var doc=main.gmail.canvasDocument;
this.el=doc.createElement("DIV");this.el.className="gtdi";var elInner=doc.createElement("DIV");elInner.className="gtdi-labelling";this.el.appendChild(elInner);this.elRows=doc.createElement("UL");elInner.appendChild(this.elRows);this._createLabelStructure();var elSpan=doc.createElement("SPAN");elSpan.className="gtdi-clearfix";this.el.appendChild(elSpan);this._main.labelsData.addEventListener(gtdLabelsData.LABEL_CHANGED,this._createLabelStructure,this);this._main.gmail.actions.addEventListener(glActionManager.THREAD_CHANGED,
this._threadUpdated,this);this._eventsContainer.observe(this.el,"click",this._click,false)},disconnect:function(){if(this.thread){this.thread.removeEventListener(glThread.THREAD_LOADED,this.refresh,this);this.thread=null}for(t in this._labellingDropdowns)this._labellingDropdowns[t].disconnect();this._main.labelsData.removeEventListener(gtdLabelsData.LABEL_CHANGED,this._createLabelStructure,this);this._main.gmail.actions.removeEventListener(glActionManager.THREAD_CHANGED,this._threadUpdated,this);
if(this.el&&this.el.parentNode)this.el.parentNode.removeChild(this.el);this.el=null;this.elRows=null;this._elCmdButtons=null;this._elNotify=null;if(this._actionAndMove)this._actionAndMove.disconnect();this._actionAndMove=null;this._eventsContainer.reset();this._eventsContainer=null;this.base()},_createLabelStructure:function(){var currentLabels=this._getCurrentLabels();for(t in this._labellingDropdowns)this._labellingDropdowns[t].disconnect();this.elRows.innerHTML="";this._uiRows={};this._labellingDropdowns=
{};if(this._actionAndMove){this._actionAndMove.disconnect();this._actionAndMove=null}var doc=this._main.gmail.canvasDocument;var typeSettings=this._main.prefs.getPref("labels.types");labelsData=this._main.labelsData;this._uiRows.statuses={};this._uiRows.statuses.el=doc.createElement("LI");this.elRows.appendChild(this._uiRows.statuses.el);this._uiRows.statuses.el.className="gtdi-row-actions";var elUL=doc.createElement("UL");this._uiRows.statuses.el.appendChild(elUL);var statuses=labelsData.getLabelsArray("statuses",
true,true);var statusData=this._main.labelsData.getStatusData(true);var isPlus=this._main.serverAccount.getAccountType()==giServerAccount.TYPES.PLUS;for(var i=0;i<statuses.length;i++){var key=statusData.reverseLookup[statuses[i]];if(key=="today"){var elLi=doc.createElement("LI");elLi.className="gtdi-label-status gtdi-label-"+key;elLi.setAttribute("gtdLabelName",statuses[i]);elLi.innerHTML="<a href='#'>"+statuses[i].replace(statusData.prefix,"")+"</a>";elUL.appendChild(elLi)}else if(key!="finished"||
!isPlus){var elLi=doc.createElement("LI");elLi.className="gtdi-label-status gtdi-label-"+key;elLi.setAttribute("gtdLabelName",statuses[i]);elLi.innerHTML="<a href='#' onclick='return false;'><b><span class='gtdi-labelname'>"+statuses[i].replace(statusData.prefix,"")+"</span></b></a>";elUL.appendChild(elLi)}}this._elCmdButtons=doc.createElement("LI");this._elCmdButtons.id="gtdi-arcfin";this._elCmdButtons.className="gtdi-btn-grp";elUL.appendChild(this._elCmdButtons);this._actionAndMove=this._main.getUIObject("conversationActionAndMove");
this._elCmdButtons.appendChild(this._actionAndMove.el);this._actionAndMove.addEventListener(gtdConversationActionAndMove.CLICK_ACTION,this._clickActionAndMove,this);this._elNotify=doc.createElement("DIV");this._elNotify.id="gtdi-notify";this._uiRows.statuses.el.appendChild(this._elNotify);this._uiRows.labels={};this._uiRows.labels.el=doc.createElement("LI");this._uiRows.labels.el.className="gtdi-row";this.elRows.appendChild(this._uiRows.labels.el);for(t in typeSettings)if(t!="statuses"&&t!="old"){this._labellingDropdowns[t]=
this._main.getUIObject("labellingDropdown");this._labellingDropdowns[t].setType(t);this._uiRows.labels.el.appendChild(this._labellingDropdowns[t].el)}this._testCmdButtons();if(this.thread)this.uiSelectLabels(this.thread.labels);else if(currentLabels.length>0)this.uiSelectLabels(currentLabels);this._elExpander=doc.createElement("DIV");this._elExpander.className="gtdi-labelling-expander";this._uiRows["statuses"].el.insertBefore(this._elExpander,this._uiRows["statuses"].el.firstChild)},load:function(thread,
autoUpdate,hideCmds,id){this._id=id?id:"";if(this.thread){this.thread.removeEventListener(glThread.THREAD_LOADED,this.refresh,this);this.thread=null}this.thread=thread;this._autoUpdate=autoUpdate;this._hideCmds=hideCmds;if(this._hideCmds)this._elCmdButtons.style.display="none";else this._elCmdButtons.style.display="";this._elNotify.innerHTML="";if(this.thread){this.thread.addEventListener(glThread.THREAD_LOADED,this.refresh,this);if(this.thread.isBasicLoaded())this.refresh()}this._expanderToggle(this._main.prefs.getPref("labelling_box.expanded"+
this._id))},refresh:function(){if(this.thread){if(this.thread.isBasicLoaded()){this.uiSelectLabels(this.thread.labels);this._testCmdButtons()}if(this.thread.isSimpleLoaded())if(this.thread.isDeleted())this._elNotify.innerHTML=giI18N.getString("Labelling.notify.deleted");else if(this.thread.isSpam())this._elNotify.innerHTML=giI18N.getString("Labelling.notify.spam")}else;},uiSelectLabels:function(labels){var doc=this._main.gmail.canvasDocument;var currentLabels=this._getCurrentLabels();for(var i=currentLabels.length-
1;i>=0;i--)if(labels.indexOf(currentLabels[i])>-1)currentLabels.splice(i,1);for(var i=0;i<currentLabels.length;i++)this._setLabel(currentLabels[i],false);for(var i=0;i<labels.length;i++)if(labels[i]&&labels[i].indexOf("^")==-1)this._setLabel(labels[i],true)},_getCurrentLabels:function(){var currentLabels=[];var result=this._main.gmail.canvasDocument.evaluate(".//*[contains(@class,'gtdi-active')]",this.elRows,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=0;i<result.snapshotLength;i++)currentLabels.push(result.snapshotItem(i).getAttribute("gtdLabelName"));
return currentLabels},_setLabel:function(labelname,isOn){if(!labelname)return;var foundType="misc";var typeSettings=this._main.prefs.getPref("labels.types");for(t in typeSettings)if(t!="misc"&&gtdLabelsData.testPrefix(labelname,typeSettings[t].prefix)){foundType=t;break}if(!foundType||!this._uiRows[foundType]&&!this._labellingDropdowns[foundType])return;var doc=this._main.gmail.canvasDocument;if(foundType=="statuses"){var elLabel=null;if(labelname.indexOf("'")>-1){var result=doc.evaluate("./li[@gtdlabelname]",
this._uiRows.statuses.el,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=0;i<result.snapshotLength;i++)if(result.snapshotItem(i).getAttribute("gtdLabelName")==labelname){elLabel=result.snapshotItem(i);break}}else elLabel=doc.evaluate(".//li[@gtdlabelname='"+labelname+"']",this._uiRows.statuses.el,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;if(elLabel)if(isOn)giUIObject.addClassName(elLabel,"gtdi-active");else giUIObject.removeClassName(elLabel,"gtdi-active")}else this._labellingDropdowns[foundType].setLabel(labelname,
isOn)},setServerActionType:function(type){this._serverActionType=type},_click:function(event){try{var el=event.target;while(el.parentNode){if(el.className=="gtdi-labeldom-expander")break;else if(el.className=="gtdi-labelremove"){var labelname=el.parentNode.getAttribute("gtdLabelName");this._removeLabel(labelname)}else if(el.getAttribute("gtdLabelName")&&!el.hasAttribute("gtdi-placeholder"))if(giUIObject.hasClassName(el,"gtdi-active"))this._removeLabel(el.getAttribute("gtdLabelName"));else this._addLabel(el.getAttribute("gtdLabelName"));
else if(giUIObject.hasClassName(el,"gtdi-droppeddown-create")){var doc=el.ownerDocument;var type=el.getAttribute("gtdLabelType");var prefix=this._main.prefs.getPref("labels.types."+type+".prefix");if(this._main.gmail.page.getActiveViewType()=="cv"&&!this._main.getUIObject("browserPopup").isActive()){this._main.gmail.actions.performAction(glActionManager.CREATE_LABEL,null,glActionManager.USE_DOM);var actionsHeader=this._main.gmail.getCurrentViewObject().getActionsHeader();setTimeout(function(){actionsHeader.getCreateLabelInput().value=
prefix},750)}else{var typeName=giI18N.getString("Labels.Types."+type,this._type);var label=prompt(giI18N.getString("Labelling.dropdown.create.prompt").replace("%1",typeName),prefix);if(label&&!this._main.labelsData.hasLabel(label))if(this.thread)this._main.gmail.actions.performAction(glActionManager.ADD_LABEL,this.thread,glActionManager.USE_AJAX,label);else{this._main.gmail.actions.performAction(glActionManager.CREATE_LABEL,null,glActionManager.USE_AJAX_SYNC,label);this._addLabel(label)}}}else if(el.className.indexOf("gtdi-archive")>
-1){if(this.thread.hasLabel("^i")){var isNext=el.className.indexOf("gtdi-archive-next")>-1;this.dispatchEvent({name:gtdLabellingBox.CLICK_ARCHIVE,moveNext:isNext,threadId:this.thread.threadId})}}else if(el.className.indexOf("gtdi-labelling-expander")>-1){this._expanderToggle();break}else if(el.className.indexOf("gtdi-label-status")>-1){giUtil.stopEvent(event);var labelname=el.getAttribute("gtdLabelName");if(giUIObject.hasClassName(el,"gtdi-active"))this._removeLabel(labelname);else this._addLabel(labelname);
break}el=el.parentNode}return false}catch(e){giLogger.warn(e,"gtdLabellingBox._click",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_expanderToggle:function(on){if(typeof on=="undefined")if(giUIObject.hasClassName(this._elExpander,"gtdi-labelling-expander-on"))on=false;else if(giUIObject.hasClassName(this._elExpander,"gtdi-labelling-expander-off"))on=true;else var on=true;for(t in this._uiRows)if(t!="statuses")this._uiRows[t].el.style.display=on?"":"none";if(on){giUIObject.removeClassName(this._elExpander,
"gtdi-labelling-expander-off");giUIObject.addClassName(this._elExpander,"gtdi-labelling-expander-on");this._elExpander.title=giI18N.getString("Labelling.expander.opened");this._elExpander.innerHTML="&minus;";on=true}else{giUIObject.removeClassName(this._elExpander,"gtdi-labelling-expander-on");giUIObject.addClassName(this._elExpander,"gtdi-labelling-expander-off");this._elExpander.title=giI18N.getString("Labelling.expander.closed");this._elExpander.innerHTML="+";on=false}this._main.prefs.setPref("labelling_box.expanded"+
this._id,on)},_addLabel:function(event){var labelname=typeof event=="string"?event:event.label;if(this.thread&&this._autoUpdate)this._main.gmail.actions.performAction(glActionManager.ADD_LABEL,this.thread,this._serverActionType,labelname);this._setLabel(labelname,true);if(this.hasEventListener(gtdLabellingBox.SELECT_LABEL))this.dispatchEvent({name:gtdLabellingBox.SELECT_LABEL,label:labelname})},_removeLabel:function(event){var labelname=typeof event=="string"?event:event.label;if(this.thread&&this._autoUpdate)this._main.gmail.actions.performAction(glActionManager.REMOVE_LABEL,
this.thread,this._serverActionType,labelname);this._setLabel(labelname,false);if(this.hasEventListener(gtdLabellingBox.UNSELECT_LABEL))this.dispatchEvent({name:gtdLabellingBox.UNSELECT_LABEL,label:labelname})},_threadUpdated:function(event){var statusData=this._main.labelsData.getStatusData();if(this.thread&&this.thread.hasId(event.thread)){if(event.label&&event.label==statusData.finished)this._testCmdButtons();if(event.action==glActionManager.ADD_LABEL)this._setLabel(event.label,true);else if(event.action==
glActionManager.REMOVE_LABEL)this._setLabel(event.label,false);else if(event.action==glActionManager.ARCHIVE)this._testCmdButtons()}},getCmdButtons:function(){return this._elCmdButtons},_testCmdButtons:function(){if(!this.thread)return;if(!this._actionAndMove)return;var buttons=[];var statusData=this._main.labelsData.getStatusData();var exclude={};exclude[gtdConversationActionAndMove.BUTTONS.SEND]=true;exclude[gtdConversationActionAndMove.BUTTONS.SEND_EOM]=true;var isArchiveable=false;if(this.thread.hasLabel("^i")){buttons.push({name:gtdConversationActionAndMove.BUTTONS.ARCHIVE,
visible:true});exclude[gtdConversationActionAndMove.BUTTONS.ARCHIVE]=true;isArchiveable=true}else if(!this.thread.hasLabel(statusData.finished)){buttons.push({name:gtdConversationActionAndMove.BUTTONS.FINISH,visible:true});exclude[gtdConversationActionAndMove.BUTTONS.ARCHIVE]=true;exclude[gtdConversationActionAndMove.BUTTONS.FINISH]=true}else{buttons.push({name:gtdConversationActionAndMove.BUTTONS.MOVE,visible:true});exclude[gtdConversationActionAndMove.BUTTONS.ARCHIVE]=true;exclude[gtdConversationActionAndMove.BUTTONS.FINISH]=
true;exclude[gtdConversationActionAndMove.BUTTONS.MOVE]=true}if(this.thread.hasLabel(statusData.finished))exclude[gtdConversationActionAndMove.BUTTONS.FINISH]=true;for(b in gtdConversationActionAndMove.BUTTONS)if(!exclude[gtdConversationActionAndMove.BUTTONS[b]])buttons.push({name:gtdConversationActionAndMove.BUTTONS[b],visible:false});if(this._main.serverAccount.getAccountType()==giServerAccount.TYPES.PLUS)this._actionAndMove.load(buttons);else if(isArchiveable){this._actionAndMove.el.style.display=
"";this._actionAndMove.load(buttons)}else this._actionAndMove.el.style.display="none"},_clickActionAndMove:function(evt){evt.threadId=this.thread.threadId;this.dispatchEvent(evt)},getActionAndMove:function(){return this._actionAndMove}},{SELECT_LABEL:"select_label",UNSELECT_LABEL:"unselect_label"});gtdLabellingBox.implement(giEventDispatcher);
