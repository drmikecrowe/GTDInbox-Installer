var gtdBoxReviews=boxSection.extend({_gtd:null,_searchBuilders:null,_searchBuildersPinned:null,connect:function(gtd){giLogger.log("st","gtdBoxReviews.connect",gtd?gtd.pageId:giLogger.UNKNOWN_PAGE_ID);this._gtd=gtd;var box=giPluginManager.getPluginInstance(boxMain,this._gtd.gmail);this.id="gtdtypes";this.base(box);this._searchBuilders={};this._searchBuildersPinned={};this.addEventListener(boxSection.POPOUT,this._popout,this);this._gtd.statusThreadsContainer.addEventListener(glThreadContainer.LOADED,
this._refreshTypeCounts,this);this._gtd.statusThreadsContainer.addEventListener(glThreadContainer.CHANGED,this._refreshTypeCounts,this);this._gtd.labelsData.addEventListener(gtdLabelsData.LABEL_CHANGED,this._labelChanged,this);if(this._main.serverAccount.getAccountType()==giServerAccount.TYPES.PLUS)this._createTypeRow(giI18N.getString("StoredSearch.Types.scheduled"),null,gtdBrowser.TYPES.STORED_SEARCH,"scheduled");var typeSettings=this._gtd.prefs.getPref("labels.types");var statusData=this._gtd.labelsData.getStatusData();
var foundOne=false;for(t in typeSettings){if(!typeSettings[t].isHidden)this._createTypeRow(giI18N.getString("Labels.Types."+t,t),giI18N.getString("Box.gtdtypes.row.tooltip").replace("%1",giI18N.getString("Labels.Types."+t,t)),gtdBrowser.TYPES.LABEL,t);foundOne=true}this.el.style.display=foundOne?"":"none";this._reloadPinnedTypeLists();this._refreshTypeCounts();this._isExpandable(true)},disconnect:function(){giLogger.log("st","gtdBoxReviews.disconnect",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);
this._gtd.statusThreadsContainer.removeEventListener(glThreadContainer.LOADED,this._refreshTypeCounts,this);this._gtd.statusThreadsContainer.removeEventListener(glThreadContainer.CHANGED,this._refreshTypeCounts,this);this._gtd.labelsData.removeEventListener(gtdLabelsData.LABEL_CHANGED,this._labelChanged,this);for(t in this._searchBuilders){giLogger.log("#IDPROBLEM(to-remove) this._searchBuilders, id: "+t,"gtdBoxReviews.disconnect",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);this._searchBuilders[t].disconnect();
delete this._searchBuilders[t]}for(t in this._searchBuildersPinned){this._searchBuildersPinned[t].disconnect();delete this._searchBuildersPinned[t]}this.base()},_createTypeRow:function(displayName,tooltip,type,subType){var id=subType?type+subType:type;if(!id)id="autoid_"+(new Date).valueOf()+parseInt(Math.random()*100);giLogger.log("st id: "+id,"gtdBoxReviews._createTypeRow",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var elRow=this._main.gmail.canvasDocument.createElement("DIV");elRow.setAttribute("gtdi-type",
type);elRow.setAttribute("gtdi-box-row-gtdtypes-labeltype",subType);elRow.title=tooltip;giUIObject.addClassName(elRow,"gtdi-box-row-gtdtypes");var elRowName=this._main.gmail.canvasDocument.createElement("DIV");elRowName.className="gtdi-box-row-gtdtypes-namecontainer";elRow.appendChild(elRowName);var elDisplayName=this._main.gmail.canvasDocument.createElement("SPAN");elDisplayName.className="gtdi-box-row-gtdtypes-name";elDisplayName.innerHTML=displayName;elRowName.appendChild(elDisplayName);var elCount=
this._main.gmail.canvasDocument.createElement("SPAN");elCount.className="gtdi-box-row-gtdtypes-count";elRowName.appendChild(elCount);var elPinned=this._main.gmail.canvasDocument.createElement("DIV");elPinned.className="gtdi-box-row-gtdtypes-pinnedcontainer";var elPopup=this._main.gmail.doc.createElement("DIV");var row=this._addRow(id,elRow,elPopup,true);row.type=type;row.subType=subType;row.elDisplayName=elDisplayName;row.elCount=elCount;row.elPinned=elPinned;row.searchBuilderRow=true;row.rowPinned=
this._addRow(id+"_pinned",row.elPinned);return row},_popout:function(evt){try{giLogger.log("st","gtdBoxReviews._popout",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var row=evt.row;giLogger.log("#IDPROBLEM(to-remove) this._searchBuilders, row.id: "+row.id,"gtdBoxReviews._popout",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);if(this._searchBuilders[row.id]){this._searchBuilders[row.id].refreshItemCounts();if(this._searchBuilders[row.id].requestReload){this._searchBuilders[row.id].reload();
this._searchBuilders[row.id].requestReload=null}}else{this._searchBuilders[row.id]=this._gtd.getUIObject("searchBuilderTypeList");this._searchBuilders[row.id].load(null,row.type,row.subType,row.id);this._searchBuilders[row.id].addEventListener(gtdSearchBuilder.OPEN_CHILD,this._sbOpenChild,this);this._searchBuilders[row.id].addEventListener(gtdSearchBuilder.HIDE,this._sbClose,this);this._searchBuilders[row.id].addEventListener(gtdSearchBuilderTypeList.TOGGLE_PIN,this._reloadPinnedTypeLists,this)}if(row.elPopout.innerHTML==
""){var doc=this._main.gmail.canvasDocument;switch(row.type){case gtdBrowser.TYPES.LABEL:if(this._gtd.labelsData.getLabelsArray(row.subType).length==0)if(row.subType=="statuses")row.elPopout.innerHTML="<button id='gtdi-box-popout-nolabels-setupgtd'>"+giI18N.getString("Box.setup.install")+"</button>";else{var info=giI18N.getString("LabelsInfo.desc."+row.subType);if(info){var elInfo=doc.createElement("DIV");elInfo.className="gtdi-box-popout-nolabels-info";elInfo.innerHTML=info;row.elPopout.appendChild(elInfo)}var typeSettings=
this._gtd.prefs.getPref("labels.types");var elNotice=doc.createElement("DIV");elNotice.className="gtdi-box-popout-nolabels-createinfo";elNotice.innerHTML=giI18N.getString("NoLabels").replace("%1",typeSettings[row.subType].prefix);row.elPopout.appendChild(elNotice);if(row.subType!="old"){var navBar=this._gtd.gmail.getUIObject("navBar");var elButton=doc.createElement("BUTTON");elButton.innerHTML=giI18N.getString("NoLabels.Create");elButton.className="gtdi-box-popup-nolabels-create";elButton.setAttribute("gtdi-newlabel-typeName",
giI18N.getString("Labels.Types."+row.subType,row.subType));elButton.setAttribute("gtdi-newlabel-prefix",typeSettings[row.subType].prefix);row.elPopout.appendChild(elButton);var elManageLabels=doc.createElement("DIV");elManageLabels.innerHTML="<a href='#' class='gtdi-manage-labels'>"+giI18N.getString("NoLabels.Manage")+"</a>";row.elPopout.appendChild(elManageLabels)}}else row.elPopout.appendChild(this._searchBuilders[row.id].el);break;case gtdBrowser.TYPES.STORED_SEARCH:row.elPopout.appendChild(this._searchBuilders[row.id].el);
break}}this._eventsContainer.stopObserving(row.elPopout,"click",this._clickTypeList,false);this._eventsContainer.observe(row.elPopout,"click",this._clickTypeList,false)}catch(e){giLogger.warn("types error: "+e,"gtdBox.popout",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_refreshTypeCounts:function(evt){giLogger.log("st","gtdBoxReviews._refreshTypeCounts",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);for(var i=0;i<this._rows.length;i++){var row=this._rows[i];if(row.searchBuilderRow){switch(row.type){case gtdBrowser.TYPES.LABEL:var count=
this._gtd.statusThreadsContainer.getCountByLabelType(row.subType);break;case gtdBrowser.TYPES.STORED_SEARCH:var count=this._gtd.statusThreadsContainer.getLabelCount(this._gtd.labelsData.getDeadlineLabel());break}if(count){row.elCount.innerHTML=" ("+count+")";giUIObject.addClassName(row.elContent,"gtdi-box-row-gtdtypes-hasitems")}else{row.elCount.innerHTML="";giUIObject.removeClassName(row.elContent,"gtdi-box-row-gtdtypes-hasitems")}}}this._refreshPinnedCounts()},_refreshPinnedCounts:function(){for(rowId in this._searchBuildersPinned)this._searchBuildersPinned[rowId].refreshItemCounts()},
_reloadPinnedTypeLists:function(evt){giLogger.log("st","gtdBoxReviews._reloadPinnedTypeLists",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var pinned=this._gtd.prefs.getPref("components.navigation.reviews.pinned")||{};for(var i=0;i<this._rows.length;i++){var row=this._rows[i];if(row.searchBuilderRow)if(pinned[row.id]&&pinned[row.id].length>0){if(!this._searchBuildersPinned[row.id]){this._searchBuildersPinned[row.id]=this._gtd.getUIObject("searchBuilderTypeList");this._searchBuildersPinned[row.id].load(null,
row.type,row.subType,row.id,true);this._searchBuildersPinned[row.id].addEventListener(gtdSearchBuilder.OPEN_CHILD,this._sbOpenChild,this);this._searchBuildersPinned[row.id].addEventListener(gtdSearchBuilder.HIDE,this._sbClose,this)}row.elPinned.innerHTML="";row.elPinned.appendChild(this._searchBuildersPinned[row.id].el)}else{row.elPinned.innerHTML="";if(this._searchBuildersPinned[row.id]){this._searchBuildersPinned[row.id].disconnect();this._searchBuildersPinned[row.id]=null;delete this._searchBuildersPinned[row.id]}}}if(evt)switch(evt.name){case gtdSearchBuilderTypeList.TOGGLE_PIN:var rowId=
evt.target.id;if(this._searchBuildersPinned[rowId])this._searchBuildersPinned[rowId].reload();break}this._refreshPinnedCounts()},_sbOpenChild:function(evt){giLogger.log("st","gtdBoxReviews._sbOpenChild",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);evt.child.addEventListener(gtdSearchBuilder.OPEN_CHILD,this._sbOpenChild,this);evt.child.addEventListener(gtdSearchBuilder.HIDE,this._sbClose,this);this._main.gmail.canvasDocument.body.appendChild(evt.child.el);var borderWidth=giUIObject.getBorderWidth(evt.elSpawn);
var offset=giUIObject.cumulativeOffset(evt.target.el);offset[1]=offset[1]+parseInt(borderWidth[3])+parseInt(borderWidth[1]);var dims=giUIObject.getDimensions(evt.target.el);var xy=[offset[0]+dims.width+5,offset[1]];evt.child.el.style.left=xy[0]+"px";evt.child.el.style.top=xy[1]+"px";xy=giUIObject.boundsCheckXY(evt.child.el,xy[0],xy[1]);evt.child.el.style.left=xy[0]+"px";evt.child.el.style.maxHeight=xy[3]+"px";var sb=evt.target;for(idSb in this._searchBuildersPinned)if(sb==this._searchBuildersPinned[idSb]){this._eventsContainer.stopObserving(this._main.gmail.canvasDocument.body,
"click",this._clickWindowPinned,false);this._eventsContainer.observe(this._main.gmail.canvasDocument.body,"click",this._clickWindowPinned,false)}},_sbClose:function(evt){giLogger.log("st","gtdBoxReviews._sbClose",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var sb=evt.target;if(sb.parent){sb.el.parentNode.removeChild(sb.el);sb.disconnect()}else{var found=false;for(idSb in this._searchBuilders){giLogger.log("#IDPROBLEM(to-remove) this._searchBuilders, id: "+idSb,"gtdBoxReviews._sbClose",
this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);if(sb==this._searchBuilders[idSb]){this._hidePopout(true);found=true;break}}if(!found)for(idSb in this._searchBuildersPinned)if(sb==this._searchBuildersPinned[idSb]){this._eventsContainer.stopObserving(this._main.gmail.canvasDocument.body,"click",this._clickWindowPinned,false);break}}},_hidePopout:function(inhibitHide){giLogger.log("st","gtdBoxReviews._hidePopout",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);if(!inhibitHide&&this._currentRow){var type=
this._currentRow.id;if(type&&this._searchBuilders[type])this._searchBuilders[type].hide()}this.base()},_click:function(evt){this.base(evt)},_clickTypeList:function(evt){try{giLogger.log("st","gtdBoxReviews._clickTypeList",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var el=evt.target;if(el.id=="gtdi-box-popup-types-statuses-overview"){var popup=this._gtd.getUIObject("browserPopup");popup.load(gtdBrowser.createBrowser(this._gtd));this._hidePopout()}else if(el.id=="gtdi-box-popout-nolabels-setupgtd"){try{this._gtd.getUIObject("setup")}catch(e){giLogger.warn(e,
"gtdBoxSetup._click",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);gBrowser.selectedTab=gBrowser.addTab("http://www.gtdinbox.com/faq.htm#gtdsetup")}this._hidePopout()}else if(el.className=="gtdi-manage-labels"){this._main.gmail.page.location("hash","#settings/labels");this._hidePopout()}else if(el.className.indexOf("gtdi-box-popup-nolabels-create")>-1){var typeName=el.getAttribute("gtdi-newlabel-typeName");var prefix=el.getAttribute("gtdi-newlabel-prefix");this._gtd.gmail.page.showCreateLabel(prefix)}}catch(e){giLogger.warn(e,
"gtdBoxReviews._clickPopup",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_clickWindow:function(evt){try{giLogger.log("st","gtdBoxReviews._clickWindow",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var el=evt.target;var data={clickedWithin:false};var f=this._generateClickWindowSearchBuilderTest(data,el);for(idSb in this._searchBuilders){giLogger.log("#IDPROBLEM(to-remove) this._searchBuilders, id: "+idSb,"gtdBoxReviews._clickWindow",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);
this._searchBuilders[idSb].recurseSearchBuilderAndChildren(f);if(data.clickedWithin)break}}catch(e){giLogger.warn(e,"gtdBoxReviews._clickWindow",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}if(data.clickedWithin);else this.base(evt)},_clickWindowPinned:function(evt){try{giLogger.log("st","gtdBoxReviews._clickWindowPinned",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);var el=evt.target;var data={clickedWithin:false,openSbs:[]};var f=this._generateClickWindowSearchBuilderTest(data,
el);for(idSb in this._searchBuildersPinned){this._searchBuildersPinned[idSb].recurseSearchBuilderAndChildren(f);if(this._searchBuildersPinned[idSb].getChild())data.openSbs.push(this._searchBuildersPinned[idSb])}if(!data.clickedWithin)for(var i=0;i<data.openSbs.length;i++)data.openSbs[i].hide()}catch(e){giLogger.warn(e,"gtdBoxReviews._clickWindowPinned",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_generateClickWindowSearchBuilderTest:function(data,el){return function(sb){var elWithin=
el;while(elWithin.parentNode&&elWithin!=sb.el)elWithin=elWithin.parentNode;if(elWithin==sb.el){data.clickedWithin=true;return true}return false}},_labelChanged:function(evt){giLogger.log("st","gtdBoxReviews._labelChanged",this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID);this._refreshTypeCounts();this._hidePopout();var affectedLabelTypes=[];if(evt.added)for(var i=0;i<evt.added.length;i++){var labelType=this._gtd.labelsData.getLabelType(evt.added[i]);if(affectedLabelTypes.indexOf(labelType)==
-1)affectedLabelTypes.push(labelType)}if(evt.removed)for(var i=0;i<evt.removed.length;i++){var labelType=this._gtd.labelsData.getLabelType(evt.removed[i]);if(affectedLabelTypes.indexOf(labelType)==-1)affectedLabelTypes.push(labelType)}for(r in this._rows){var row=this._rows[r];if(row.type==gtdBrowser.TYPES.LABEL)if(affectedLabelTypes.indexOf(row.subType)>-1){if(this._searchBuilders[row.id])this._searchBuilders[row.id].requestReload=true;if(this._searchBuildersPinned[row.id])this._searchBuildersPinned[row.id].reload();
if(row.elPopout)row.elPopout.innerHTML=""}}},expanded:function(v){if(v)for(var i=0;i<this._rows.length;i++)this._rows[i].el.style.display="";else if(typeof v!="undefined")for(var i=0;i<this._rows.length;i++)this._rows[i].el.style.display="none";return this.base(v)}});
