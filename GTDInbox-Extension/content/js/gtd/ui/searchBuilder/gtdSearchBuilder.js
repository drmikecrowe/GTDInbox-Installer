var gtdSearchBuilder=giUIObject.extend({el:null,_selectedType:null,_selectedItem:null,parent:null,_elSpawn:null,_currentChild:null,connect:function(main){giLogger.log("st","gtdSearchBuilder.connect",main?main.pageId:giLogger.UNKNOWN_PAGE_ID);this.base(main);var doc=this._main.gmail.canvasDocument;this.el=doc.createElement("DIV")},disconnect:function(){if(this._currentChild)this._currentChild.disconnect();this._currentChild=null;this.parent=null;this._selectedItem=null;this._elSpawn=null;this._removeAllListeners();
for(p in this)if(this.hasOwnProperty(p)&&this[p]&&this[p].nodeName)this[p]=null;this.base()},hide:function(all){if(all&&this.parent){var sb=this;while(sb.parent)sb=sb.parent;sb.hide(all)}else{var result=this.el.ownerDocument.evaluate(".//*[contains(@class, 'gtdi-active')]",this.el,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=0;i<result.snapshotLength;i++)giUIObject.removeClassName(result.snapshotItem(i),"gtdi-active");var cc=this._currentChild;if(cc)cc.hide();this.dispatchEvent({name:gtdSearchBuilder.HIDE})}},
load:function(parent){if(parent)this.parent=parent;this._selectedItem=null;this._elSpawn=null;if(this._currentChild)this._currentChild.hide()},reload:function(){this.load(this.parent)},refreshCounts:function(){throw new Error("Override gtdSearchBuilder.refreshCounts");},_setCurrent:function(type,item,el){if(this._selectedItem!=item){if(this._elSpawn)giUIObject.removeClassName(this._elSpawn,"gtdi-active");this._selectedType=type;this._selectedItem=item;this._elSpawn=el;if(this._currentChild)this._currentChild.hide()}},
getCurrentItem:function(){return this._selectedItem},getChild:function(){return this._currentChild},recurseSearchBuilderAndChildren:function(f){if(f(this))return;if(this._currentChild)this._currentChild.recurseSearchBuilderAndChildren(f)},openChild:function(){if(!this._currentChild){this._currentChild=this._createChild();this._currentChild.load(this);this._currentChild.addEventListener(gtdSearchBuilder.HIDE,this._childRequestedHide,this);this.dispatchEvent({name:gtdSearchBuilder.OPEN_CHILD,elSpawn:this._elSpawn,
child:this._currentChild});if(this._elSpawn)giUIObject.addClassName(this._elSpawn,"gtdi-active")}},_createChild:function(){throw new Error("Override gtdSearchBuilder._createChild");},_childRequestedHide:function(evt){if(this._currentChild)this._currentChild=null},getSearch:function(searchStr){if(!searchStr)searchStr="";if(searchStr)searchStr+=" ";searchStr+="("+this._getSearchInner()+")";if(this.parent)searchStr=this.parent.getSearch(searchStr);return searchStr},_getSearchInner:function(){switch(this._selectedType){case gtdBrowser.TYPES.LABEL:search=
[];search.push(glSearch.l(this._selectedItem));var childLabels=this._main.labelsData.getChildLabels(this._selectedItem);for(var i=0;i<childLabels.length;i++)search.push(glSearch.l(childLabels[i]));return search.join(" OR ");case gtdBrowser.TYPES.SEARCH:return this._selectedItem;case gtdBrowser.TYPES.STORED_SEARCH:var search=this._main.storedSearch.getSearchText(this._selectedItem);return search}}},{HIDE:"gtdSearchBuilder.hide",OPEN_CHILD:"gtdSearchBuilder.open_child"});gtdSearchBuilder.implement(giEventDispatcher);
