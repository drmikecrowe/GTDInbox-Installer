var gtdSearchBuilderLabelMenu=gtdSearchBuilder.extend({_elToDo:null,_elViews:null,disconnect:function(){this._eventsContainer.reset();this._eventsContainer=null;this.base()},load:function(parent){this.base(parent);var doc=this._main.gmail.canvasDocument;if(parent){var labelType=this.parent.getLabelType();this.el.className+=" gtdi-searchbuilder-labelsmenu";this._eventsContainer=new giEventsContainer(this);this._eventsContainer.observe(this.el,"mousedown",this._click,false);if(labelType!="statuses"){this._elToDo=
doc.createElement("DIV");this._elToDo.className="gtdi-searchbuilder-labelsmenu-todo";this.el.appendChild(this._elToDo);var elTitle=doc.createElement("DIV");elTitle.className="gtdi-searchbuilder-labelsmenu-title";elTitle.innerHTML=giI18N.getString("SearchBuilder.LabelsMenu.todo.title");this._elToDo.appendChild(elTitle)}this._elViews=doc.createElement("DIV");this._elViews.className="gtdi-searchbuilder-labelsmenu-views";this.el.appendChild(this._elViews);var elTitle=doc.createElement("DIV");elTitle.className=
"gtdi-searchbuilder-labelsmenu-title";elTitle.innerHTML=giI18N.getString("SearchBuilder.LabelsMenu.views.title");this._elViews.appendChild(elTitle);if(labelType!="statuses"){var statusData=this._main.labelsData.getStatusData();var statuses=this._main.labelsData.getLabelsArray("statuses",true);for(var i=0;i<statuses.length;i++)if(statuses[i]!=statusData.finished){var elRow=this._addRow(statuses[i].replace(statusData.prefix,""),glSearch.l(statuses[i]),this._elToDo);elRow.setAttribute("gtdi-isStatus",
"1")}}var views=this._main.views.getViews();for(var i=0;i<views.length;i++){var id=views[i];this._addRow(this._main.views.getViewName(id),this._main.views.getViewSearch(id),this._elViews)}}var count=0;var statusThreads=this._main.statusThreadsContainer.threads;var search=this.parent.getSearch();var condition=new glSearchConditions;search.addCondition(condition);var result=doc.evaluate(".//*[@class='gtdi-searchbuilder-labelsmenu-row']",this.el,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);for(var i=
0;i<result.snapshotLength;i++){var elRow=result.snapshotItem(i);condition.conditions[0]=elRow.getAttribute("gtdi-search");if(this._main.statusThreadsContainer.isStatusConstrained(search)){count=0;for(var j=0;j<statusThreads.length;j++)if(search.matchThread(statusThreads[j]))count++;elRow.innerHTML=elRow.innerHTML.replace(/\s\(\d+\)$/,"");elRow.innerHTML+=" ("+count+")"}}},_addRow:function(name,search,elContainer){var doc=this._main.gmail.canvasDocument;var elRow=doc.createElement("DIV");elRow.className=
"gtdi-searchbuilder-labelsmenu-row";elRow.setAttribute("gtdi-name",name);elRow.setAttribute("gtdi-search",search);elRow.innerHTML=giI18N.getString("SearchBuilder.LabelsMenu."+name,name);if(!elContainer)elContainer=this.el;elContainer.appendChild(elRow);var elImg=doc.createElement("IMG");elImg.className="gtdi-searchbuilder-labelsmenu-row-popup";elImg.src=giUrl.getURL("skin/gtd/popout.png");elImg.title=giI18N.getString("Box.popup").replace("%1",name);elRow.appendChild(elImg);return elRow},_getSearchInner:function(){return new glSearchConditions(this.currentItem)},
_click:function(evt){try{var el=evt.target;if(giUIObject.hasClassName(el,"gtdi-searchbuilder-labelsmenu-row")){this._setCurrent(el.getAttribute("gtdi-search"));var searchStr=this.getSearch().toString();this._main.gmail.page.location("hash","search/"+encodeURIComponent(searchStr));this.hide(true);return}else if(el.className.indexOf("gtdi-searchbuilder-labelsmenu-row-popup")>-1){while(el.parentNode&&el.getAttribute&&!el.getAttribute("gtdi-search"))el=el.parentNode;if(!el.parentNode||!el.getAttribute)return;
var labelName=this.parent.currentItem;var searchStr=el.getAttribute("gtdi-search");if(labelName){var type=this._main.labelsData.getLabelType(labelName).toUpperCase();var browser=gtdBrowser.createBrowser(this._main,labelName);var popup=this._main.getUIObject("browserPopup");popup.load(browser);var tab=browser.getTabBySearch(searchStr);if(tab)browser.selectTab(tab);this.hide(true)}}}catch(e){giLogger.warn(e,"gtdSearchBuilderLabelMenu._click",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}}});
