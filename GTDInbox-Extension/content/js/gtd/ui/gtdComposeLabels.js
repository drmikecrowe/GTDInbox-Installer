var gtdComposeLabels=giUIObject.extend({el:null,conversationLabels:null,_labels:null,_eventsContainer:null,connect:function(main){giLogger.log("st","gtdComposeLabels.connect",main?main.pageId:giLogger.UNKNOWN_PAGE_ID);this.base(main);this._eventsContainer=new giEventsContainer(this);this._labels=[];var doc=main.gmail.canvasDocument;this.conversationLabels=main.getUIObject("labellingBox");giUIObject.addClassName(this.conversationLabels.el,"gtdi-compose-labels");this.conversationLabels.addEventListener(gtdLabellingBox.SELECT_LABEL,
this._selectLabel,this);this.conversationLabels.addEventListener(gtdLabellingBox.UNSELECT_LABEL,this._unSelectLabel,this);this.conversationLabels.load(null,null,true,"compose");this.el=doc.createElement("TR");var elTd=doc.createElement("TD");elTd.setAttribute("colspan","3");elTd.appendChild(this.conversationLabels.el);this.el.appendChild(elTd);if(this._main.gmail.offline.isUnstable())this.el.style.display="none";this._main.gmail.offline.addEventListener(glOffline.GO_ONLINE,this._offlineStateChange,
this);this._main.gmail.offline.addEventListener(glOffline.GO_UNSTABLE,this._offlineStateChange,this);var composeView=main.gmail.getCurrentViewObject();composeView.composeTable.getElementsByTagName("TBODY")[0].appendChild(this.el);this._eventsContainer.observe(composeView.topSendButton,"click",this._clickSend,true);this._eventsContainer.observe(composeView.bottomSendButton,"click",this._clickSend,true)},disconnect:function(){this.conversationLabels.removeEventListener(gtdLabellingBox.SELECT_LABEL,
this._selectLabel,this);this.conversationLabels.removeEventListener(gtdLabellingBox.UNSELECT_LABEL,this._unSelectLabel,this);this.conversationLabels.disconnect();if(this.el)this.el.parentNode.removeChild(this.el);this.el=null;this._eventsContainer.reset();this.base()},_offlineStateChange:function(evt){if(evt.name==glOffline.GO_ONLINE)this.el.style.display="";else if(evt.name==glOffline.GO_UNSTABLE)this.el.style.display="none"},_clickSend:function(event){try{if(!this._main.gmail.offline.isUnstable()){var composeView=
this._main.gmail.getCurrentViewObject();var subject=composeView.subjectField.value;if(this._labels.length>0)this._main.preLabeler.labelNextSent(this._labels,subject)}}catch(e){giLogger.warn(e,"gtdComposeLabels._clickSend",null,this._main?this._main.pageId:giLogger.UNKNOWN_PAGE_ID)}},_selectLabel:function(event){for(var i=0;i<this._labels.length;i++)if(this._labels[i]==event.label)return;this._labels.push(event.label);var statusData=this._main.labelsData.getStatusData(true);if(gtdLabelsData.testPrefix(event.label,
statusData.prefix))if(!this._main.labelsData.allowMultipleStatuses(event.label,statusData)){var statuses=this._main.labelsData.getLabelsArray("statuses");for(var i=0;i<statuses.length;i++)if(statuses[i]!=event.label){var idx=this._labels.indexOf(statuses[i]);if(idx>-1)this._labels.splice(idx,1)}}this.conversationLabels.uiSelectLabels(this._labels)},_unSelectLabel:function(event){for(var i=0;i<this._labels.length;i++)if(this._labels[i]==event.label){this._labels.splice(i,1);break}this.conversationLabels.uiSelectLabels(this._labels)}});
