var glTrafficWatcherTracer=giBase.extend({_gmail:null,connect:function(gmail){try{giLogger.log("st","glTrafficWatcherTracer.connect",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);this._gmail=gmail;var me=this;setTimeout(function(){me._start()},100)}catch(e){giLogger.warn("Error connecting glTrafficWatcherTracer: "+e,"glTrafficWatcherTracer.chrome.js",null,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}},shutdown:function(){giLogger.log("Disconnecting traffic watcher from page",
"glTrafficWatcherTracer",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);this._dispatchEvent("shutdown");if(this._injectedCodeElem){this._injectedCodeElem.parentNode.removeChild(this._injectedCodeElem);this._injectedElem.parentNode.removeChild(this._injectedElem)}this._removeAllListeners();this._gmail=false},_start:function(){try{var me=this;giFileIO.readFile("content/js/gmail/glTrafficWatcherTracer.injected.chrome.js",null,null,function(fileText){me._start_postReadCode(fileText)})}catch(e){giLogger.warn("Error injecting code "+
e,"glTrafficWatcherTracer.chrome.js",null,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}},_start_postReadCode:function(code){try{var doc=this._gmail.canvasDocument;this._injectedCodeElem=doc.createElement("SCRIPT");this._injectedCodeElem.setAttribute("type","text/javascript");this._injectedCodeElem.textContent=code;this._injectedCodeElem.firebugIgnore=true;var elHead=doc.getElementsByTagName("HEAD")[0];if(elHead)elHead.appendChild(this._injectedCodeElem);else doc.documentElement.appendChild(this._injectedCodeElem);
this._start_getInjected()}catch(e){giLogger.warn(e,"glTrafficWatcherTracer.chrome.js._start_postReadCode",null,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}},_start_getInjected:function(count){if(!count)count=0;var doc=this._gmail.canvasDocument;this._injectedElem=doc.getElementById("_glTrafficWatcherTracerInjected");var me=this;if(this._injectedElem){this._injectedListener=function(e){me._eventReceived(e)};this._injectedElem.addEventListener("glTrafficWatcherTracerInjectedEvent",this._injectedListener,
false,true)}else if(count<20){count=count+1;setTimeout(function(){me._start_getInjected(count)},500)}else giLogger.error("Could not find injected element for traffic watcher.","glTrafficWatcherTracer.chrome.js",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)},getResponseData:function(responseDataId,previous){return this._dispatchEvent("getResponseData",responseDataId,previous)},_eventReceived:function(evt){try{var eventName=this._injectedElem.getAttribute("event");var d=this._injectedElem.getAttribute("eventData");
if(d)var data=giJson.decode(d).data;switch(eventName){case "examineRequest":var evt={name:glTrafficWatcherTracer.NEW_REQUEST,url:data.url,postData:data.body,responseDataId:data.responseDataId};this.dispatchEvent(evt);this._injectedElem.setAttribute("return",giJson.encode({data:{listenForComplete:evt.listenForComplete}}));break;case "receiveXhrResponse":this.dispatchEvent({name:glTrafficWatcherTracer.REQUEST_COMPLETE,url:data.url,responseText:data.responseText});break;case "receiveIframeResponse":this.dispatchEvent({name:glTrafficWatcherTracer.REQUEST_COMPLETE,
url:data.url,responseDataId:data.responseDataId});break;case "log":giLogger.log(data,"glTrafficWatcherTracer.injected.chrome.js _log",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);break}}catch(e){giLogger.warn(e,"glTrafficWatcherTracerDoc.chrome.js _eventReceived",null,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}},_dispatchEvent:function(eventName){var elem=this._injectedElem;elem.setAttribute("event",eventName);var args=[];for(var i=1;i<arguments.length;i++)args.push(arguments[i]);
var argsJson=giJson.encode(args);elem.setAttribute("arguments",argsJson);var evt=document.createEvent("Events");evt.initEvent("glTrafficWatcherTracerEvent",true,false);elem.dispatchEvent(evt);var returnValue=null;try{if(elem.getAttribute("return"))returnValue=giJson.decode(elem.getAttribute("return")).data}catch(e){}elem.removeAttribute("event");elem.removeAttribute("arguments");elem.removeAttribute("return");return returnValue}},{NEW_REQUEST:"new_request",REQUEST_COMPLETE:"request_complete"});glTrafficWatcherTracer.implement(giEventDispatcher);
