var glThreadListTable=giBase.extend({id:null,_gmail:null,_search:null,_threads:null,actionsHeader:null,el:null,_elTableContainer:null,elTable:null,isMain:null,threadsAreLoaded:null,_eventsContainer:null,_integrityCheckTimeout:null,_multipleInboxIndex:null,constructor:function(gmail,elContainer,isMain,threadListView,multipleInboxIndex){this.id=parseInt((new Date).valueOf()*Math.random());this._gmail=gmail;this.isMain=isMain;this._multipleInboxIndex=multipleInboxIndex;var doc=this._gmail.canvasDocument;
this._eventsContainer=new giEventsContainer(this);if(!elContainer)elContainer=this._gmail.page.getViewRoot();this.el=elContainer;this._tryLoadActionsHeader();var results=doc.evaluate(".//div[@class='nH Cp']",elContainer,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);this._elTableContainer=giUIObject.shallowestSnapshotItem(results,elContainer);if(!this._elTableContainer)giLogger.error("Could not find the elTableContainer","glThreadListTable.connect",this._gmail.pageId);this._elTableContainer=this._elTableContainer.parentNode.parentNode;
this._eventsContainer.observe(this._elTableContainer,"DOMNodeInserted",this._domNodeInserted,false);this.elTable=this._getElTable();if(!this.elTable){var me=this;this._integrityCheckTimeout=setTimeout(function(){me._elTableIntegrityCheck()},12E3)}},unload:function(){if(this._unloaded){giLogger.logConcern("glThreadListTable object unload called more than once","glThreadListTable.unload",this._gmail.pageId);return}else this._unloaded=true;if(this._integrityCheckTimeout){clearTimeout(this._integrityCheckTimeout);
this._integrityCheckTimeout=null}if(this.actionsHeader){this.actionsHeader.disconnect();this.actionsHeader=null}this.el=null;this.elTable=null;this._elTableContainer=null;this._removeAllListeners();this._eventsContainer.reset();this._eventsContainer=null;this._gmail=null},_tryLoadActionsHeader:function(){try{this.actionsHeader=this._gmail.getUIObject("actionsHeader");var hasValidRoot=this.actionsHeader.getValidRoot(this.el);if(hasValidRoot)this.actionsHeader.load(this.el);else if(this.isMain)giLogger.error("Could not find root node for actions header on main table",
"glThreadListTable.constructor",this._gmail.pageId);else;}catch(e){this.actionsHeader=null;if(this.isMain)giLogger.error(e,"glThreadListTable._tryLoadActionsHeader",this._gmail.pageId);else;}},getPaginationInfo:function(){if(!this.isMain)new Error("Function only available on main table.");var result=this._gmail.canvasDocument.evaluate(".//span/b",this.actionsHeader.pagination,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);if(!result.singleNodeValue){var result=this._gmail.canvasDocument.evaluate(".//div[@class='Di']",
this.actionsHeader.pagination,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null);if(result.singleNodeValue&&result.singleNodeValue.childNodes.length==1&&result.singleNodeValue.childNodes[0].nodeType==3)return{startingOffset:0,endingOffset:0,result:0};else giLogger.error("Could not find pagination element. Presume HTML/CSS change.","glThreadListView.getPaginationInfo",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}var span=result.singleNodeValue.parentNode;var bNodes=span.getElementsByTagName("b");
return{startingOffset:parseInt(bNodes[0].textContent),endingOffset:parseInt(bNodes[1].textContent),results:parseInt(bNodes[2].textContent)}},getRowOffset:function(el){var offset=0;while(el.parentNode&&el.nodeName!="TR")el=el.parentNode;if(el.nodeName=="TR")while(el.previousSibling){offset++;el=el.previousSibling}return offset},_isThreadListEmpty:function(){if(!this.elTable)giLogger.error("elTable not loaded yet.","glThreadListTable._isThreadListEmpty",this._gmail.pageId);return/cf (zq|HmCP1d)/.test(this.elTable.className)},
getLastTDInRows:function(){if(!this.elTable)giLogger.error("elTable not loaded yet.","glThreadListTable.getLastTDInRows",this._gmail.pageId);var doc=this._gmail.canvasDocument;var result=doc.evaluate(".//tr[starts-with(@class,'zA')]//td[last()]",this.elTable,null,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);if(result.snapshotLength==0)if(!this._isThreadListEmpty())giLogger.error("Could not find last TD in rows.","glThreadListView.getLastTDInRows",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);
return result},checkRow:function(offset){if(!this.elTable)giLogger.error("elTable not loaded yet.","glThreadListTable.checkRow",this._gmail.pageId);var elInputs=this.elTable.getElementsByTagName("INPUT");if(elInputs[offset]){var el=elInputs[offset];if(el.checked==false)giUIObject.simulateMouseEvent(el,"click")}},_domNodeInserted:function(evt){if(evt.target.nodeName=="DIV"||evt.target.nodeName=="TABLE"){giLogger.log("st","glThreadListTable._domNodeInserted",this._gmail.pageId);if(evt.target.nodeName==
"TABLE"||evt.target.getElementsByTagName("TABLE")[0]){giLogger.log("Proper refresh - reload table and reset threads","glThreadListTable._domNodeInserted",this._gmail.pageId);var me=this;setTimeout(function(){me._domNodeInserted_ProcessChange()},50)}}},_domNodeInserted_ProcessChange:function(){try{this.elTable=this._getElTable();if(this._search||this.threadsAreLoaded||this._threads){if(this._search){this._search.unload();this._search=null}this.threadsAreLoaded=false;this._threads=null;this.dispatchEvent({name:glThreadListTable.THREADS_CLEARED})}this.dispatchEvent({name:glThreadListTable.UI_REFRESHED})}catch(e){giLogger.warn(e,
"glThreadListTable._domNodeInserted",null,this._gmail.pageId)}},_getElTable:function(){giLogger.log("st","glThreadListTable.getElTable",this._gmail.pageId);if(this.isMain){var paginationInfo=this.getPaginationInfo();if(paginationInfo.startingOffset==0&&paginationInfo.endingOffset==0){giLogger.log("get empty table","glThreadListTable._getElTable",this._gmail.pageId);var result=this._gmail.canvasDocument.evaluate(".//table[contains(@class, 'cf zq') or contains(@class, 'cf HmCP1d')]",this._elTableContainer,
null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return result}else{giLogger.log("get normal table","glThreadListTable._getElTable",this._gmail.pageId);var result=this._gmail.canvasDocument.evaluate(".//table[contains(@class, 'cf zt')]",this._elTableContainer,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return result}}else{giLogger.log("get multiple inbox table","glThreadListTable._getElTable",this._gmail.pageId);var result=this._gmail.canvasDocument.evaluate(".//table[contains(@class, 'cf zt') or contains(@class, 'cf zq') or contains(@class, 'cf HmCP1d')]",
this._elTableContainer,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return result}},_elTableIntegrityCheck:function(){this._integrityCheckTimeout=null;if(!this.elTable){var paginationStr="(No pagination info)";try{var paginationInfo=this.getPaginationInfo();paginationStr="(Pagination info = Starting offset: "+paginationInfo.startingOffset+", Ending offset: "+paginationInfo.endingOffset+")"}catch(e){}giLogger.warn("elTable failed to load in Gmail. Check HTML/CSS for changes.","glThreadListTable._elTableIntegrityCheck",
"isMain: "+this.isMain+", url: "+this._gmail.page.location("href")+"\n"+paginationStr,this._gmail.pageId)}},getSearchString:function(callback){try{if(this.isMain)callback(glSearch.getQueryFromUrl(this._gmail));else if(this._gmail.settings.isLoaded())callback(this._gmail.settings.data.multiple_inboxes.items[this._multipleInboxIndex].query);else{var id=(new Date).valueOf();var me=this;this["func_"+id]=function(){try{giLogger.log("settings load complete","glThreadLisTable.getSearchString",me._gmail.pageId);
me._gmail.settings.removeEventListener(glSettings.LOADED,me["func_"+id],this);callback(me._gmail.settings.data.multiple_inboxes.items[me._multipleInboxIndex].query);delete me["func_"+id]}catch(e){giLogger.warn(e,"glThreadListTable.getSearchString [settings-callback]",null,this._gmail.pageId)}};this._gmail.settings.addEventListener(glSettings.LOADED,this["func_"+id],this);this._gmail.settings.load()}}catch(e){giLogger.warn(e,"glThreadListTable.getSearchString",null,this._gmail.pageId)}},getThreads:function(){return this._getThreads()},
_getThreads:function(){if(this.threadsAreLoaded)return this._threads.slice();else{giLogger.log("(tlt-dl) request start tlt thread download (url: "+this._gmail.page.location("href")+")","glThreadListTable._getThreads",this._gmail.pageId);var me=this;this.getSearchString(function(searchStr){me._getThreads_gotSearchString(searchStr)})}},_getThreads_gotSearchString:function(searchStr){giLogger.log("(tlt-dl) start tlt thread download (url: "+this._gmail.page.location("href")+")","glThreadListTable._getThreads_gotSearchString",
this._gmail.pageId);if(this.threadsAreLoaded);else if(!this._search||!this._search.isBackgroundRunning()){giLogger.log("(tlt-dl) start approved for tlt thread download","glThreadListTable._getThreads_gotSearchString",this._gmail.pageId);if(this._search)this._search.unload();this._search=new glSearch(this._gmail);this._search.addEventListener(glSearch.COMPLETED,this._getThreads_searchComplete,this);this._search.find(searchStr);giLogger.log("(tlt-dl) search: "+searchStr,"glThreadListTable._getThreads_gotSearchString",
this._gmail.pageId);if(this.isMain){var paginationInfo=this.getPaginationInfo();var num=paginationInfo.endingOffset-(paginationInfo.startingOffset-1);giLogger.log("(tlt-dl) is main with pagination. start: "+(paginationInfo.startingOffset-1)+", num: "+num,"glThreadListTable._getThreads_gotSearchString",this._gmail.pageId);this._search.runBackground(paginationInfo.startingOffset-1,num)}else this._search.runBackground()}},_getThreads_searchComplete:function(evt){this._threads=this._search.getResults();
this.threadsAreLoaded=true;this.dispatchEvent({name:glThreadListTable.THREADS_LOADED})},getThread:function(offset){var threads=this._getThreads();if(threads)if(offset<threads.length)return threads[offset];else giLogger.error("Requested thread offset ("+offset+") that exceeds length of threads array ("+threads.length+")","glThreadListTable.getThread",this._gmail.pageId);return null}},{THREADS_LOADED:"threads_loaded",THREADS_CLEARED:"threads_cleared",UI_REFRESHED:"ui_refreshed"});glThreadListTable.implement(giEventDispatcher);
