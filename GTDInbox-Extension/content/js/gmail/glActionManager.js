var glActionManager=giBase.extend({actionBuffer:null,actionDOMBuffer:null,_recentActions:null,_gmail:null,connect:function(gmail){this._gmail=gmail;this.actionBuffer=new glActionBuffer(gmail);this.actionBufferSync=new glActionBuffer(gmail);this.actionBufferSync.async=false;this._recentActions=[];this.actionDOMBuffer=new glActionDOMBuffer(gmail);this._gmail.trafficWatcher.addEventListener(glTrafficWatcher.ACTION_REQUEST,this._environmentGeneratedAction,this)},shutdown:function(){this._gmail.trafficWatcher.removeEventListener(glTrafficWatcher.ACTION_REQUEST,
this._environmentGeneratedAction,this);this._gmail.trafficWatcher.removeEventListener(glTrafficWatcher.ACTION_REQUEST_COMPLETED,this._actionsWithNoThreads_ThreadsDownloadedEvent,this);this._gmail.trafficWatcher.removeEventListener(glTrafficWatcher.THREAD_LIST_REQUEST_COMPLETED,this._actionsWithNoThreads_ThreadsDownloadedEvent,this);this._gmail=null;this.actionBuffer.shutdown();this._removeAllListeners()},performAction:function(action,threads,serverActionType,label,actionsHeader){if(serverActionType==
glActionManager.USE_DOM){var args=[];args.push(actionsHeader);if(label)args.push(label);this.actionDOMBuffer[action["bufferFunc"]].apply(this.actionDOMBuffer,args)}else{if(typeof threads!="array")threads=[threads];for(var i=0;i<threads.length;i++){var threadId=threads[i]instanceof glThread?threads[i].threadId:threads[i];var callback=null;if(serverActionType!=glActionManager.USE_DOM){var performedAction={action:action,serverActionType:serverActionType};if(threadId){performedAction.itemType="thread";
performedAction.item=threadId}else performedAction.itemType="environment";if(label)performedAction.label=label;if(threads[i]instanceof glThread)performedAction.threadObject=threads[i];var me=this;callback=function(){me._distributeAction(performedAction)}}if(this.actionBuffer[action["bufferFunc"]]&&(serverActionType==glActionManager.USE_AJAX||serverActionType==glActionManager.USE_AJAX_SYNC||!this.actionDOMBuffer[action["bufferFunc"]])){var args=[];if(threadId)args.push(threadId);if(label)args.push(label);
if(callback)args.push(callback);if(serverActionType==glActionManager.USE_AJAX)this.actionBuffer[action["bufferFunc"]].apply(this.actionBuffer,args);else this.actionBufferSync[action["bufferFunc"]].apply(this.actionBufferSync,args)}}}},_environmentGeneratedAction:function(evt,actions){giLogger.log("st","glActionManager._environmentGeneratedAction",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);if(!actions)actions=this._parseURLAndData(evt.url,evt.postData,evt);if(actions)for(var i=0;i<actions.length;i++){actions[i].environmentGenerated=
true;this._distributeAction(actions[i])}},_distributeAction:function(action){giLogger.log("Notifying listeners that an action took place. Item type: "+action.itemType+", action: "+action.action.eventName+", serverActionType: "+action.serverActionType+", environmentGenerated: "+action.environmentGenerated,"glActionManager._distributeAction",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);if(action.itemType=="thread"){this.dispatchEvent({name:"thread_action_"+action.item,action:action.action,
serverActionType:action.serverActionType,threadObject:action.threadObject,environmentGenerated:action.environmentGenerated,performActionRequest:action.performActionRequest,label:action.label});this.dispatchEvent({name:glActionManager.THREAD_CHANGED,action:action.action,thread:action.item,serverActionType:action.serverActionType,threadObject:action.threadObject,environmentGenerated:action.environmentGenerated,performActionRequest:action.performActionRequest,label:action.label})}else if(action.itemType==
"environment"){var evt={name:glActionManager.ENVIRONMENT_CHANGED,action:action.action,label:action.label,newLabel:action.newLabel,serverActionType:action.serverActionType,environmentGenerated:action.environmentGenerated,performActionRequest:action.performActionRequest};this.dispatchEvent(evt)}else{var evt={name:glActionManager.MESSAGE_CHANGED,action:action.action,message:action.item,serverActionType:action.serverActionType,threadObject:action.threadObject,environmentGenerated:action.environmentGenerated,
performActionRequest:action.performActionRequest};if(action.label)evt.label=action.label;this.dispatchEvent(evt)}this.dispatchEvent({name:action.action.eventName,item:action.item,itemType:action.itemType,serverActionType:action.serverActionType,threadObject:action.threadObject,environmentGenerated:action.environmentGenerated,performActionRequest:action.performActionRequest,label:action.label,newLabel:action.newLabel,query:action.query})},_parseURLAndData:function(url,postData,evt){giLogger.log("st",
"glActionManager._parseURLAndData",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);if(typeof postData!="string")giLogger.logConcern("postData is not a string: "+postData+", url: "+url,"glActionManager._parseURLAndData",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);var match=/[?&]act=([^&]+)/.exec(url);if(!match)return[];var actions=[];var urlAction=match[1];postData=postData.replace(/^&+/,"").replace(/&+$/,"");if(/cc_|nc_|dc_/i.test(urlAction)){var itemType="environment";var items=
null}else if(/&?t=/.test(postData)){postData=postData.replace(/(^|&)[^t][^&]+/g,"");var itemType="thread";var items=postData.split(/&?t=/)}else if(/&?m=/.test(postData)){var itemType="message";var items=postData.split(/&?m=/)}else{var itemType="unknown";var items=null}if(items)items.shift();var glGmail=this._gmail;var addActionForItems=function(data){if(items&&items.length>0)for(var i=0;i<items.length;i++){var action={itemType:itemType,item:items[i]};for(d in data)action[d]=data[d];if(itemType=="thread")if(glGmail.page.getActiveViewType()==
"cv"){var conversationView=glGmail.getCurrentViewObject();if(conversationView.isThreadCreated()){var cvThread=conversationView.getThread(true);if(cvThread&&cvThread.hasId(action.item))action.threadObject=cvThread}}actions.push(action)}else{var action={itemType:itemType};for(d in data)action[d]=data[d];actions.push(action)}};if(urlAction=="arl"){var addLabelRegex=new RegExp("[&?]acn=([^&]+)","g");var removeLabelRegex=new RegExp("[&?]rcn=([^&]+)","g");var matches=null;var actionsTemp=[];while((matches=
addLabelRegex.exec(url))!=null)actionsTemp.push({action:glActionManager.ADD_LABEL,label:decodeURIComponent(matches[1])});while((matches=removeLabelRegex.exec(url))!=null)actionsTemp.push({action:glActionManager.REMOVE_LABEL,label:decodeURIComponent(matches[1])});for(var i=0;i<actionsTemp.length;i++)addActionForItems(actionsTemp[i])}else if(/^ac_/.test(urlAction)){var label=decodeURIComponent(/^ac_(.*)/.exec(urlAction)[1]);addActionForItems({action:glActionManager.ADD_LABEL,label:label})}else if(/^rc_/.test(urlAction)){var label=
decodeURIComponent(/^rc_(.*)/.exec(urlAction)[1]);if(label=="^i")addActionForItems({action:glActionManager.ARCHIVE});else addActionForItems({action:glActionManager.REMOVE_LABEL,label:label})}else if(urlAction=="sp")addActionForItems({action:glActionManager.REPORT_SPAM});else if(urlAction=="us")addActionForItems({action:glActionManager.NOT_SPAM});else if(urlAction=="st")addActionForItems({action:glActionManager.STAR});else if(urlAction=="xst")addActionForItems({action:glActionManager.UNSTAR});else if(urlAction==
"tr")addActionForItems({action:glActionManager.DELETE});else if(urlAction=="ib")addActionForItems({action:glActionManager.MOVE_INBOX});else if(urlAction.substr(0,3)=="cc_")addActionForItems({action:glActionManager.CREATE_LABEL,label:decodeURIComponent(urlAction.substr(3))});else if(urlAction.substr(0,3)=="nc_"){var label=decodeURIComponent(urlAction.substr(3)).split("^");addActionForItems({action:glActionManager.RENAME_LABEL,label:label[0],newLabel:label[1]})}else if(urlAction.substr(0,3)=="dc_")addActionForItems({action:glActionManager.DELETE_LABEL,
label:decodeURIComponent(urlAction.substr(3))});if(items||itemType=="environment")return actions;else if(actions.length>0){this._actionsWithNoThreads(url,actions,evt);return null}},_actionsWithNoThreads:function(url,actions,evt){giLogger.log("st","glActionManager._actionsWithNoThreads",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);if(!this._actionsWithNoThreadsQueue)this._actionsWithNoThreadsQueue=[];if(this._actionsWithNoThreadsQueue.length==0){this._gmail.trafficWatcher.addEventListener(glTrafficWatcher.ACTION_REQUEST_COMPLETED,
this._actionsWithNoThreads_ThreadsDownloadedEvent,this);this._gmail.trafficWatcher.addEventListener(glTrafficWatcher.THREAD_LIST_REQUEST_COMPLETED,this._actionsWithNoThreads_ThreadsDownloadedEvent,this)}this._actionsWithNoThreadsQueue.push({url:url,actions:actions,responseDataId:evt.responseDataId,attempts:0});giLogger.log("queue event with responseDataId: "+evt.responseDataId+"\nurl: "+url,"glActionManager._actionsWithNoThreads",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);this._actionsWithNoThreads_ThreadsDownloadedEvent()},
_actionsWithNoThreads_ThreadsDownloadedEvent:function(evt){giLogger.log("st, queue length: "+this._actionsWithNoThreadsQueue.length,"glActionManager._actionsWithNoThreads_ThreadsDownloadedEvent",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);if(evt&&!evt.responseDataId)return;if(this._actionsWithNoThreadsQueue.length>1)giLogger.logConcern("_actionsWithNoThreadsQueue length greater than 1: "+this._actionsWithNoThreadsQueue.length,"glActionManager._actionsWithNoThreads_ThreadsDownloadedEvent",
this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);for(var i=this._actionsWithNoThreadsQueue.length-1;i>=0;i--){var item=this._actionsWithNoThreadsQueue[i];if(item.attempts>10){this._actionsWithNoThreadsQueue.splice(i,1);giLogger.warn("Removed item from _actionsWithNoThreadsQueue for being too old","glActionManager._actionsWithNoThreads_ThreadsDownloadedEvent","responseDataId: "+item.responseDataId+"\noriginal evt url: "+item.url,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID)}else{var threadsData=
this._gmail.trafficWatcher.getResponseData(item.responseDataId);if(threadsData){this._actionsWithNoThreadsQueue.splice(i,1);this._actionsWithNoThreads_gotThreadsForEvent(item.url,item.actions,item.responseDataId,threadsData)}else item.attempts++}}if(this._actionsWithNoThreadsQueue.length==0){this._gmail.trafficWatcher.removeEventListener(glTrafficWatcher.ACTION_REQUEST_COMPLETED,this._actionsWithNoThreads_ThreadsDownloadedEvent,this);this._gmail.trafficWatcher.removeEventListener(glTrafficWatcher.THREAD_LIST_REQUEST_COMPLETED,
this._actionsWithNoThreads_ThreadsDownloadedEvent,this)}},_actionsWithNoThreads_gotThreadsForEvent:function(url,actions,responseDataId,threadsData){giLogger.log("st: responseDataId"+responseDataId,"glActionManager._actionsWithNoThreads_gotThreadsForEvent",this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);var previousThreadsData=this._gmail.trafficWatcher.getResponseData(responseDataId,true);if(!previousThreadsData){giLogger.warn("Could not find previous threadsData","glActionManager._actionsWithNoThreads_gotThreadsForEvent",
"original event url: "+url,this._gmail?this._gmail.pageId:giLogger.UNKNOWN_PAGE_ID);return}var threads=threadsData.getThreads();var previousThreads=previousThreadsData.getThreads();var addedThreads=[];var removedThreads=[];var changedThreads=[];var existingThreads=[];for(var i=0;i<previousThreads.length;i++){var found=false;var thread=null;for(var j=0;j<threads.length;j++)if(previousThreads[i].hasId(threads[j].threadId)){thread=threads[j];break}if(!thread){changedThreads.push(previousThreads[i]);
removedThreads.push(previousThreads[i])}}for(var i=0;i<threads.length;i++){var found=false;var previousThread=null;for(var j=0;j<previousThreads.length;j++)if(threads[i].hasId(previousThreads[j].threadId)){previousThread=previousThreads[j];break}if(!previousThread){changedThreads.push(previousThreads[i]);addedThreads.push(threads[i])}else existingThreads.push([previousThread,threads[i]])}var newActions=[];var fCloneActionForThread=function(action,actionThread,prioritise){var newAction={item:actionThread.threadId,
itemType:"thread"};for(d in action)if(!newAction[d])newAction[d]=action[d];if(prioritise)newActions.splice(0,0,newAction);else newActions.push(newAction)};for(var i=0;i<removedThreads.length;i++)for(var j=0;j<actions.length;j++)fCloneActionForThread(actions[j],removedThreads[i]);for(var i=0;i<actions.length;i++){var action=actions[i];var addedLabel=null;var removedLabel=null;var prioritise=false;if(action.action==glActionManager.ADD_LABEL){addedLabel=action.label;prioritise=true}if(action.action==
glActionManager.REMOVE_LABEL)removedLabel=action.label;if(action.action==glActionManager.ARCHIVE)removedLabel="^i";if(action.action==glActionManager.REPORT_SPAM)addedLabel="^s";if(action.action==glActionManager.NOT_SPAM)removedLabel="^s";if(action.action==glActionManager.STAR)removedLabel=action.label;if(action.action==glActionManager.UNSTAR)removedLabel=action.label;if(action.action==glActionManager.DELETE)addedLabel="^k";if(action.action==glActionManager.MOVE_INBOX)addedLabel="^i";for(var j=0;j<
existingThreads.length;j++){var previousThread=existingThreads[j][0];var thread=existingThreads[j][1];if(addedLabel){if(!previousThread.hasLabel(addedLabel)&&thread.hasLabel(addedLabel))fCloneActionForThread(action,thread,prioritise)}else if(removedLabel)if(previousThread.hasLabel(removedLabel)&&!thread.hasLabel(removedLabel))fCloneActionForThread(action,thread,prioritise)}}this._environmentGeneratedAction(null,newActions)}},{ADD_LABEL:{bufferFunc:"addLabelToThread",eventName:"label_added"},REMOVE_LABEL:{bufferFunc:"removeLabelFromThread",
eventName:"label_removed"},STAR:{bufferFunc:"addStarToThread",eventName:"star_added"},UNSTAR:{bufferFunc:"removeStarFromThread",eventName:"star_removed"},ARCHIVE:{bufferFunc:"archiveThread",eventName:"item_archived"},MOVE_INBOX:{bufferFunc:"moveInbox",eventName:"item_move_inbox"},DELETE:{bufferFunc:"deleteThread",eventName:"item_deleted"},REPORT_SPAM:{bufferFunc:"spamThread",eventName:"item_reported_spam"},NOT_SPAM:{bufferFunc:"notSpamThread",eventName:"item_not_spam"},MARK_AS_READ:{bufferFunc:"markThreadRead",
eventName:"item_marked_read"},CREATE_LABEL:{bufferFunc:"createLabel",eventName:"label_created"},RENAME_LABEL:{bufferFunc:"renameLabel",eventName:"label_renamed"},DELETE_LABEL:{bufferFunc:"deleteLabel",eventName:"label_deleted"},HIDE_LABEL:{bufferFunc:"hideLabel",eventName:"label_hidden"},ENVIRONMENT_CHANGED:"environment_changed",THREAD_CHANGED:"thread_changed",MESSAGE_CHANGED:"message_changed",USE_AJAX:"ajax",USE_AJAX_SYNC:"ajax_sync",USE_DOM:"dom"});glActionManager.implement(giEventDispatcher);
